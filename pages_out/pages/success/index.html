<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relay — Success</title>
  <style>
    html,body{margin:0;padding:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    .card{margin-top:12px;padding:14px;border-radius:12px;background:rgba(255,255,255,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    a.btn,button{display:inline-block;padding:12px 14px;border-radius:10px;border:0;background:#1976d2;color:#fff;text-decoration:none;cursor:pointer}
    a.secondary,button.secondary{background:rgba(255,255,255,.14)}
    .muted{opacity:.82;font-size:13px}
    .bad{color:#ff8a80}
    code{word-break:break-all;display:block;background:rgba(255,255,255,.06);padding:10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Payment successful</h2>
    <div class="card">
      <div id="msg" class="muted">Loading your event…</div>

      <div id="out" style="margin-top:12px; display:none;">
        <div class="row">
          <a id="watchBtn" class="btn" href="#" target="_blank" rel="noopener">Watch link</a>
          <a id="broadcastBtn" class="btn secondary" href="#" target="_blank" rel="noopener">Broadcast link (phone)</a>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Watch link (share this):</div>
          <code id="watchUrl"></code>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Broadcast link (keep private):</div>
          <code id="broadcastUrl"></code>
        </div>

        <div style="margin-top:12px;" class="muted">
          Tip: open the Broadcast link on your phone → tap “Go Live”.
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://stream-platform-api.kiwismurph.workers.dev";
  const msg = document.getElementById("msg");
  const out = document.getElementById("out");
  const watchBtn = document.getElementById("watchBtn");
  const broadcastBtn = document.getElementById("broadcastBtn");
  const watchUrlEl = document.getElementById("watchUrl");
  const broadcastUrlEl = document.getElementById("broadcastUrl");

  function setErr(e) {
    msg.innerHTML = `<span class="bad">${e}</span>`;
  }

  (async () => {
    const parts = location.pathname.split("/");
    const eventId = parts[parts.length-1] || "";
    const st = new URLSearchParams(location.search).get("st") || "";
    if (!eventId || !st) {
      setErr("Missing event id or token.");
      return;
    }

    try {
      const r = await fetch(`${API_BASE}/api/events/${eventId}/links?st=${encodeURIComponent(st)}`);
      const text = await r.text();
      let j; try { j = JSON.parse(text); } catch { j = null; }
      if (!r.ok) {
        const err = (j && (j.error||j.message)) ? (j.error||j.message) : (text || "Request failed");
        setErr(err);
        return;
      }

      const watchUrl = j.watch_url;
      const broadcastUrl = j.broadcast_url;

      watchBtn.href = watchUrl;
      broadcastBtn.href = broadcastUrl;
      watchUrlEl.textContent = watchUrl;
      broadcastUrlEl.textContent = broadcastUrl;

      msg.textContent = "Your links are ready.";
      out.style.display = "block";
    } catch (e) {
      setErr("Network error.");
    }
  })();
</script>
</body>
</html>
