<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Broadcast</title>
  <script src="https://web-broadcast.live-video.net/1.10.0/amazon-ivs-web-broadcast.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      text-align: center;
    }
    video { width: 100%; max-width: 600px; background: black; border-radius: 10px; }
    button {
      margin-top: 16px;
      padding: 14px 26px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #00c853;
      color: white;
      cursor: pointer;
    }
    button.stop { background: #d50000; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 12px; opacity: 0.9; max-width: 600px; }
    .warn { color: #ffcc80; }
    .bad { color: #ff8a80; }
  </style>
</head>
<body>

  <video id="preview" autoplay playsinline muted></video>
  <button id="toggleBtn" disabled>Loadingâ€¦</button>
  <div id="status">Initializingâ€¦</div>

<script>
  // ðŸ”§ Set this to your Worker origin (or proxy API through Pages)
  const API = "https://stream-platform-api.kiwismurph.workers.dev";

  const preview = document.getElementById("preview");
  const button = document.getElementById("toggleBtn");
  const statusEl = document.getElementById("status");

  const parts = location.pathname.split("/").filter(Boolean);
  const eventId = parts[1]; // /broadcast/:eventId
  const key = new URLSearchParams(location.search).get("key");

  let client;
  let localStream;
  let broadcasting = false;

  let sid = null;
  let cfg = null;
  let hbTimer = null;

  function setStatus(msg, cls="") {
    statusEl.className = cls;
    statusEl.textContent = msg;
  }

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const json = await res.json().catch(() => ({}));
    return { res, json };
  }

  async function claimLock() {
    const { res, json } = await postJSON(`${API}/api/broadcast/claim`, { eventId, key });
    if (!res.ok) throw new Error(json.error || "Claim failed");
    sid = json.broadcast_session_id;
  }

  async function fetchConfig() {
    const url = `${API}/api/broadcast/config?eventId=${encodeURIComponent(eventId)}&key=${encodeURIComponent(key)}&sid=${encodeURIComponent(sid)}`;
    const res = await fetch(url);
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Config failed");
    cfg = json;
  }

  async function broadcastStarted() {
    const { res, json } = await postJSON(`${API}/api/broadcast/started`, { eventId, key });
    if (!res.ok) throw new Error(json.error || "Failed to mark started");
  }

  async function heartbeatOnce() {
    const { res, json } = await postJSON(`${API}/api/broadcast/heartbeat`, {
      eventId, key, broadcast_session_id: sid
    });
    if (!res.ok || json.still_owner === false) {
      stopBecauseKicked();
    }
  }

  function startHeartbeat() {
    stopHeartbeat();
    hbTimer = setInterval(heartbeatOnce, 12000);
  }

  function stopHeartbeat() {
    if (hbTimer) clearInterval(hbTimer);
    hbTimer = null;
  }

  async function releaseLock() {
    if (!sid) return;
    try {
      await postJSON(`${API}/api/broadcast/release`, { eventId, key, broadcast_session_id: sid });
    } catch {}
  }

  function stopBecauseKicked() {
    setStatus("This broadcast was opened elsewhere. Youâ€™ve been disconnected.", "bad");
    stopBroadcast().catch(()=>{});
    button.disabled = true;
  }

  async function init() {
    if (!eventId || !key) {
      setStatus("Missing eventId or key.", "bad");
      return;
    }
    try {
      setStatus("Claiming broadcast sessionâ€¦");
      await claimLock();

      setStatus("Fetching broadcast configâ€¦");
      await fetchConfig();

      setStatus("Ready. Press Start Broadcast.");
      button.textContent = "Start Broadcast";
      button.disabled = false;

      startHeartbeat();
    } catch (e) {
      console.error(e);
      setStatus(e.message || "Init failed", "bad");
      button.textContent = "Error";
      button.disabled = true;
    }
  }

  async function startBroadcast() {
    try {
      button.disabled = true;
      setStatus("Requesting camera & micâ€¦");

      await heartbeatOnce();

      localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: 1280, height: 720 },
        audio: true
      });

      preview.srcObject = localStream;

      setStatus("Starting IVS broadcastâ€¦");

      client = IVSBroadcastClient.create({
        streamConfig: IVSBroadcastClient.STANDARD_LANDSCAPE,
        ingestEndpoint: cfg.ingestEndpoint
      });

      client.addVideoInputDevice(localStream, "camera1");
      client.addAudioInputDevice(localStream, "mic1");

      await client.startBroadcast(cfg.streamKey);

      broadcasting = true;
      button.textContent = "Stop Broadcast";
      button.classList.add("stop");
      button.disabled = false;

      setStatus("Live âœ…");
      await broadcastStarted();

    } catch (err) {
      console.error("Error starting broadcast:", err);
      setStatus("Failed to start broadcast. Check permissions and try again.", "bad");
      button.disabled = false;
    }
  }

  async function stopBroadcast() {
    try {
      stopHeartbeat();

      if (client && broadcasting) {
        setStatus("Stopping broadcastâ€¦");
        await client.stopBroadcast();
      }

      broadcasting = false;
      button.textContent = "Start Broadcast";
      button.classList.remove("stop");

      if (localStream) {
        for (const track of localStream.getTracks()) track.stop();
        localStream = null;
      }
      preview.srcObject = null;

      setStatus("Stopped.");
      await releaseLock();

      // Re-claim so you can start again easily
      setStatus("Re-claiming sessionâ€¦");
      await claimLock();
      await fetchConfig();
      setStatus("Ready. Press Start Broadcast.");
      startHeartbeat();
      button.disabled = false;

    } catch (err) {
      console.error("Error stopping broadcast:", err);
      setStatus("Stopped (with warnings).", "warn");
      try { await releaseLock(); } catch {}
    }
  }

  button.addEventListener("click", () => {
    if (!broadcasting) startBroadcast();
    else stopBroadcast();
  });

  window.addEventListener("beforeunload", () => {
    try {
      navigator.sendBeacon?.(`${API}/api/broadcast/release`, JSON.stringify({
        eventId, key, broadcast_session_id: sid
      }));
    } catch {}
  });

  init();
</script>

<div style="margin-top:18px; font-size:12px; opacity:.75; text-align:center">
  By using this service you agree to the <a href="/terms" style="color:#9ad1ff">Terms</a> and <a href="/privacy" style="color:#9ad1ff">Privacy Policy</a>.
</div>

</body>
</html>
