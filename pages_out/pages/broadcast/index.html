<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relay Broadcast</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    video { width: 100%; max-width: 900px; background: #000; border-radius: 12px; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin: 12px 0; }
    button { padding: 12px 16px; border-radius: 10px; border: 0; font-weight: 700; }
    .err { color: #b00020; white-space: pre-wrap; }
    code { word-break: break-all; }
  </style>
  <!-- IVS Web Broadcast SDK -->
  <script src="https://web-broadcast.live-video.net/1.32.0/amazon-ivs-web-broadcast.js"></script>
</head>
<body>
  <h1>Relay Broadcast</h1>

  <div class="box">
    <div><b>Event:</b> <code id="eventId"></code></div>
    <div><b>Broadcast Key:</b> <code id="key"></code></div>
    <div><b>Status:</b> <span id="status">Ready</span></div>
    <div class="err" id="err"></div>
  </div>

  <button id="go">Go Live</button>
  <button id="stop" disabled>Stop</button>

  <div class="box">
    <video id="preview" playsinline autoplay muted></video>
  </div>

  <script>
    const API_BASE = "https://stream-platform-api.kiwismurph.workers.dev";

    function parseEventId() {
      const parts = location.pathname.split("/").filter(Boolean);
      const idx = parts.indexOf("broadcast");
      return idx >= 0 ? (parts[idx + 1] || "") : "";
    }

    let stage = null;
    let localStream = null;

    async function main() {
      const eventId = parseEventId();
      const key = new URLSearchParams(location.search).get("key") || "";
      document.getElementById("eventId").textContent = eventId || "(missing)";
      document.getElementById("key").textContent = key || "(missing)";

      if (!eventId || !key) {
        document.getElementById("status").textContent = "Missing eventId or key in URL";
        return;
      }

      document.getElementById("go").onclick = () => goLive(eventId, key);
      document.getElementById("stop").onclick = stopLive;
    }

    async function goLive(eventId, key) {
      try {
        setStatus("Requesting camera/mic…");
        document.getElementById("err").textContent = "";

        // 1) Get host token + stageArn (this provisions stage if needed)
        setStatus("Provisioning RTC…");
        const res = await fetch(`${API_BASE}/api/events/${eventId}/rtc/provision?key=${encodeURIComponent(key)}`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: "{}"
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(`rtc/provision failed: ${res.status} ${JSON.stringify(data)}`);

        const stageArn = data.stageArn;
        const token = data.participantToken;
        if (!stageArn || !token) throw new Error("Missing stageArn/token from rtc/provision");

        // 2) Capture devices
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("preview").srcObject = localStream;

        setStatus("Joining stage…");

        // 3) Build stage strategy
        const { Stage, LocalStageStream, SubscribeType } = IVSBroadcastClient;

        const localVideoTrack = localStream.getVideoTracks()[0];
        const localAudioTrack = localStream.getAudioTracks()[0];

        const streamsToPublish = [
          new LocalStageStream(localVideoTrack),
          new LocalStageStream(localAudioTrack),
        ];

        const strategy = {
          stageStreamsToPublish() { return streamsToPublish; },
          shouldPublishParticipant() { return true; },
          shouldSubscribeToParticipant() { return SubscribeType.NONE; } // host doesn't need to subscribe
        };

        stage = new Stage(token, strategy);

        stage.on(Stage.Events.STAGE_CONNECTION_STATE_CHANGED, (state) => {
          console.log("Stage state:", state);
        });

        await stage.join();

        setStatus("LIVE ✅");
        document.getElementById("go").disabled = true;
        document.getElementById("stop").disabled = false;
      } catch (err) {
        setStatus("Error");
        document.getElementById("err").textContent = String(err?.stack || err);
      }
    }

    async function stopLive() {
      try {
        setStatus("Stopping…");
        if (stage) await stage.leave();
        stage = null;

        if (localStream) {
          for (const t of localStream.getTracks()) t.stop();
          localStream = null;
        }
        document.getElementById("preview").srcObject = null;

        setStatus("Stopped");
        document.getElementById("go").disabled = false;
        document.getElementById("stop").disabled = true;
      } catch (err) {
        setStatus("Error");
        document.getElementById("err").textContent = String(err?.stack || err);
      }
    }

    function setStatus(s) {
      document.getElementById("status").textContent = s;
    }

    main().catch(err => {
      document.getElementById("status").textContent = "Error";
      document.getElementById("err").textContent = String(err?.stack || err);
    });
  </script>
</body>
</html>