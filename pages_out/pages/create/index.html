<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relay — Create Event</title>
  <style>
    html,body{margin:0;padding:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    .card{margin-top:12px;padding:14px;border-radius:12px;background:rgba(255,255,255,.08)}
    label{display:block;margin-top:10px;opacity:.9}
    input,select{width:100%;padding:12px;border-radius:10px;border:0;margin-top:8px;font-size:16px}
    button{margin-top:14px;padding:12px 16px;border-radius:10px;border:0;background:#1976d2;color:#fff;font-size:16px;cursor:pointer;width:100%}
    button:disabled{opacity:.65;cursor:not-allowed}
    .muted{opacity:.82;font-size:13px}
    .bad{color:#ff8a80}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.10);cursor:pointer;user-select:none}
    .pill input{width:auto;margin:0}
    .price{font-size:22px;font-weight:700;margin-top:10px}
    .tiny{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Create a live event</h2>
    <div class="card">
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" />

      <label>Title</label>
      <input id="title" type="text" placeholder="My live stream" />

      <label>Duration</label>
      <select id="tier">
        <option value="3">Standard (3 hours)</option>
        <option value="8">Extended (8 hours)</option>
      </select>

      <label>Delivery (choose one)</label>
      <div class="row" style="margin-top:8px;">
        <label class="pill"><input type="radio" name="mode" value="webrtc" checked /> WebRTC (real-time)</label>
        <label class="pill"><input type="radio" name="mode" value="hls" /> HLS (few sec delay)</label>
        <label class="pill"><input type="radio" name="mode" value="both" /> Both</label>
      </div>

      <label style="margin-top:12px;"><input id="wl" type="checkbox" /> White-label (hide footer)</label>

      <div id="price" class="price">$—</div>
      <div id="priceNote" class="tiny">Pricing loads from the API (so you can change prices without redeploying Pages).</div>

      <button id="go" type="button">Pay & Create</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

<script>
  const API_BASE = "https://stream-platform-api.kiwismurph.workers.dev";
  const msg = document.getElementById("msg");
  const goBtn = document.getElementById("go");
  const priceEl = document.getElementById("price");

  function setMsg(html, cls="") {
    msg.className = `muted ${cls}`.trim();
    msg.innerHTML = html;
  }

  function getMode() {
    const el = document.querySelector('input[name="mode"]:checked');
    return el ? el.value : "webrtc";
  }

  let pricing = null;

  async function loadPricing() {
    try {
      const r = await fetch(`${API_BASE}/api/pricing`);
      const j = await r.json();
      if (j && j.ok) pricing = j;
    } catch (e) {
      // ignore
    }
    updatePriceUI();
  }

  function nzdCentsToDollars(cents) {
    const n = Number(cents || 0);
    return (n/100).toFixed(2);
  }

  function calcPrice() {
    if (!pricing) return null;
    const tier = document.getElementById("tier").value;
    const mode = getMode();
    const base = pricing.tiers[tier].base_nzd;
    const add = mode === "hls" ? pricing.addons.hls_nzd : (mode === "webrtc" ? pricing.addons.webrtc_nzd : pricing.addons.both_nzd);
    return base + add;
  }

  function updatePriceUI() {
    const total = calcPrice();
    if (total === null) {
      priceEl.textContent = "$—";
      return;
    }
    priceEl.textContent = `$${nzdCentsToDollars(total)} NZD`;
  }

  document.getElementById("tier").addEventListener("change", updatePriceUI);
  document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", updatePriceUI));

  goBtn.addEventListener("click", async () => {
    goBtn.disabled = true;
    setMsg("Creating event…");

    const email = document.getElementById("email").value.trim();
    const title = document.getElementById("title").value.trim();
    const tier = Number(document.getElementById("tier").value);
    const mode = getMode();
    const white_label = document.getElementById("wl").checked;

    if (!email || !title) {
      setMsg('<span class="bad">Email + title are required.</span>');
      goBtn.disabled = false;
      return;
    }

    const body = { email, title, tier, white_label, mode };

    let res, text, json;
    try {
      res = await fetch(`${API_BASE}/api/events`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      text = await res.text();
      try { json = JSON.parse(text); } catch { json = null; }
    } catch (e) {
      setMsg('<span class="bad">Network error.</span>');
      goBtn.disabled = false;
      return;
    }

    if (!res.ok) {
      const err = (json && (json.error || json.message)) ? (json.error || json.message) : (text || "Request failed");
      setMsg(`<span class="bad">${err}</span>`);
      goBtn.disabled = false;
      return;
    }

    const checkoutUrl = json && json.checkout_url;
    if (!checkoutUrl) {
      setMsg('<span class="bad">Missing checkout URL.</span>');
      goBtn.disabled = false;
      return;
    }

    console.log("CHECKOUT URL:", checkoutUrl);
alert(checkoutUrl);
  });

  loadPricing();
</script>
</body>
</html>
