<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relay Watch</title>

  <!-- ✅ Amazon IVS Real-Time Web (Broadcast) SDK -->
  <script src="https://web-broadcast.live-video.net/1.17.0/amazon-ivs-web-broadcast.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    video { width: 100%; max-width: 900px; background: #000; border-radius: 12px; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin: 12px 0; }
    .err { color: #b00020; white-space: pre-wrap; }
    code { word-break: break-all; }
  </style>
</head>
<body>

<h1>Relay Watch</h1>

<div class="box">
  <div><b>Event:</b> <code id="eventId"></code></div>
  <div><b>Status:</b> <span id="status">Loading…</span></div>
  <div class="err" id="err"></div>
</div>

<video id="video" playsinline autoplay controls></video>

<script>
const API_BASE = "https://stream-platform-api.kiwismurph.workers.dev";

const statusEl = document.getElementById("status");
const errEl = document.getElementById("err");
const videoEl = document.getElementById("video");

function getParam(name) {
  return new URLSearchParams(location.search).get(name) || "";
}

async function fetchPublic(eventId, key) {
  const res = await fetch(`${API_BASE}/api/events/${eventId}/public?key=${encodeURIComponent(key)}`);
  const data = await res.json();
  if (!res.ok) throw new Error(`public failed: ${res.status} ${JSON.stringify(data)}`);
  return data;
}

async function fetchViewerToken(eventId, key) {
  const res = await fetch(`${API_BASE}/api/events/${eventId}/rtc/token?key=${encodeURIComponent(key)}`, {
    method: "POST"
  });
  const data = await res.json();
  if (!res.ok) throw new Error(`rtc/token failed: ${res.status} ${JSON.stringify(data)}`);
  return data;
}

function getIvsSdk() {
  // ✅ the Web Broadcast SDK exposes IVSBroadcastClient
  const sdk = window.IVSBroadcastClient;
  if (!sdk) return null;
  if (!sdk.Stage || !sdk.StageEvents) return null;
  return sdk;
}

async function joinStage(participantToken) {
  const sdk = getIvsSdk();
  if (!sdk) throw new Error("IVS Realtime SDK not loaded (IVSBroadcastClient missing)");

  // Viewer strategy: subscribe only, publish nothing
  const strategy = {
    stageStreamsToPublish: () => [],
    shouldPublishParticipant: () => false,
    shouldSubscribeToParticipant: () => true,
  };

  const stage = new sdk.Stage(participantToken, strategy);

  stage.on(sdk.StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => {
    statusEl.textContent = "Connection: " + state;
  });

  stage.on(sdk.StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED, (participant, streams) => {
    for (const stream of streams) {
      if (stream.mediaStreamTrack && stream.mediaStreamTrack.kind === "video") {
        const ms = new MediaStream([stream.mediaStreamTrack]);
        videoEl.srcObject = ms;
      }
      // (optional) audio
      if (stream.mediaStreamTrack && stream.mediaStreamTrack.kind === "audio") {
        // If you want audio, merge tracks:
        const current = videoEl.srcObject instanceof MediaStream ? videoEl.srcObject : new MediaStream();
        current.addTrack(stream.mediaStreamTrack);
        videoEl.srcObject = current;
      }
    }
  });

  stage.on(sdk.StageEvents.STAGE_PARTICIPANT_STREAMS_REMOVED, () => {
    // If broadcaster stops, clear video
    videoEl.srcObject = null;
  });

  await stage.join();
}

async function main() {
  const eventId = getParam("id");
  const key = getParam("key");

  document.getElementById("eventId").textContent = eventId || "(missing)";

  if (!eventId || !key) {
    statusEl.textContent = "Missing eventId or key";
    return;
  }

  const pub = await fetchPublic(eventId, key);

  if (pub.expired) {
    statusEl.textContent = "This event has ended.";
    return;
  }

  if (!pub.rtc_enabled) {
    statusEl.textContent = "RTC not enabled.";
    return;
  }

  if (!pub.rtc_stage_arn) {
    statusEl.textContent = "Not live yet… waiting for host.";
    return;
  }

  statusEl.textContent = "Requesting viewer token…";
  const tokenData = await fetchViewerToken(eventId, key);

  statusEl.textContent = "Joining live stream…";
  await joinStage(tokenData.participantToken);

  statusEl.textContent = "Live";
}

main().catch(err => {
  statusEl.textContent = "Error";
  errEl.textContent = err?.stack || String(err);
});
</script>

</body>
</html>