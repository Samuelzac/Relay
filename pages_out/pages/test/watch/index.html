<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Test Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <style>
    html, body { margin:0; padding:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; height:100%; }
    .wrap { max-width:920px; margin:0 auto; padding:14px; }
    h1 { font-size:18px; margin:10px 0 8px; font-weight:650; }
    video { width:100%; background:#000; border-radius:10px; display:none; }
    .card { margin-top:10px; padding:14px; border-radius:12px; background:rgba(255,255,255,0.08); line-height:1.35; }
    .muted { opacity:0.85; }
    .bad { color:#ff8a80; }
    .ok { color:#b9f6ca; }
    .wait { display:flex; gap:12px; align-items:center; }
    .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.9); animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    button { margin-top:12px; padding:12px 16px; border-radius:10px; border:0; background:rgba(255,255,255,0.14); color:#fff; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Test stream</h1>
    <video id="player" controls playsinline autoplay></video>
    <div id="panel" class="card">Loading…</div>
    <button id="retry">Retry</button>
  </div>

<script>
  const API = "https://YOUR-WORKER-DOMAIN";

  const parts = location.pathname.split("/").filter(Boolean);
  const testId = parts[2]; // /test/watch/:testId

  const player = document.getElementById("player");
  const panel = document.getElementById("panel");
  const retry = document.getElementById("retry");

  let hls;
  let pollTimer = null;

  function html(s){ panel.innerHTML = s; }

  function stopPlayback() {
    try { player.pause(); } catch {}
    player.removeAttribute("src");
    player.load();
    if (hls) { try { hls.destroy(); } catch {} hls = null; }
    player.style.display = "none";
  }

  function startHls(url) {
    player.style.display = "block";
    if (player.canPlayType("application/vnd.apple.mpegurl")) {
      player.src = url;
      return;
    }
    if (window.Hls && Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(player);
      return;
    }
    html(`<div class="bad">This browser can’t play the stream.</div>`);
  }

  async function load() {
    stopPlayback();
    if (pollTimer) clearInterval(pollTimer);

    if (!testId) {
      html(`<div class="bad">Invalid test link.</div>`);
      return;
    }

    html(`
      <div class="wait">
        <div class="spinner"></div>
        <div>
          <div><b>Waiting for test broadcast…</b></div>
          <div class="muted">This will end automatically after 2 minutes.</div>
        </div>
      </div>
    `);

    async function checkOnce() {
      const res = await fetch(`${API}/api/test/${testId}`);
      const meta = await res.json().catch(()=> ({}));
      if (!res.ok) {
        html(`<div class="bad">${meta.error || "Not found"}</div>`);
        return;
      }
      if (meta.expired) {
        stopPlayback();
        html(`<div class="bad"><b>Test ended</b></div><div class="muted">You can close this window.</div>`);
        if (pollTimer) clearInterval(pollTimer);
        return;
      }
      if (meta.playback_url) {
        html(`<div class="ok"><b>Live</b></div><div class="muted">If it doesn’t start, tap play.</div>`);
        startHls(meta.playback_url);
      }
    }

    await checkOnce();
    pollTimer = setInterval(checkOnce, 3000);
  }

  retry.onclick = load;
  load();
</script>

<div style="margin-top:18px; font-size:12px; opacity:.75; text-align:center">
  By using this service you agree to the <a href="/terms" style="color:#9ad1ff">Terms</a> and <a href="/privacy" style="color:#9ad1ff">Privacy Policy</a>.
</div>

</body>
</html>
